services:
  # PostgreSQL database
  # Used by both Evolution API (when WA2AI_PROVIDER=evolution) and wa2ai routes persistence
  postgres:
    image: postgres:16-alpine
    container_name: evolution-postgres
    environment:
      - POSTGRES_DB=evolution_lab
      - POSTGRES_USER=evolution
      - POSTGRES_PASSWORD=evolution_pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Mount schema initialization script
      - ./schema:/docker-entrypoint-initdb.d
    networks:
      - wa2ai-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U evolution"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Evolution API service (only included if COMPOSE_PROFILES includes 'evolution')
  # Automatically included when WA2AI_PROVIDER=evolution via wrapper script
  evolution-api-lab:
    image: evoapicloud/evolution-api:v2.3.7
    container_name: evolution-api-lab
    profiles:
      - evolution
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Authentication
      - AUTHENTICATION_API_KEY=${EVOLUTION_API_KEY:-default_key_change_me}
      # Server configuration
      - SERVER_URL=http://evolution-api-lab:8080
      - SERVER_PORT=8080
      # Database configuration (PostgreSQL for lab environment)
      # See: https://doc.evolution-api.com/v2/en/requirements/database
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://evolution:evolution_pass@postgres:5432/evolution_lab?schema=public
      - DATABASE_CONNECTION_CLIENT_NAME=evolution_exchange
      # Choose what data to save in database
      - DATABASE_SAVE_DATA_INSTANCE=true
      - DATABASE_SAVE_DATA_NEW_MESSAGE=true
      - DATABASE_SAVE_MESSAGE_UPDATE=true
      - DATABASE_SAVE_DATA_CONTACTS=true
      - DATABASE_SAVE_DATA_CHATS=true
      - DATABASE_SAVE_DATA_LABELS=true
      - DATABASE_SAVE_DATA_HISTORIC=true
      # Logging (configurable per developer)
      - LOG_LEVEL=${EVOLUTION_LOG_LEVEL:-INFO}
      # Session configuration
      - CONFIG_SESSION_PHONE_CLIENT=Chrome
      - CONFIG_SESSION_PHONE_NAME=wa2ai-lab
      # BAILEYS_VERSION is auto-detected in v2.3.7, no need to specify
      # QR Code configuration
      - QRCODE_COLOR=#175197
      - QRCODE_LIMIT=30
      # Webhook configuration
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_GLOBAL_URL=http://wa2ai-lab:3000/webhooks/whatsapp/lab
      - WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=false
      # Enable specific webhook events
      - WEBHOOK_EVENTS_MESSAGES_UPSERT=true
      - WEBHOOK_EVENTS_CONNECTION_UPDATE=true
      - WEBHOOK_EVENTS_QRCODE_UPDATED=true
    volumes:
      - evolution_data:/evolution/.store
    networks:
      - wa2ai-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  wa2ai-lab:
    build:
      context: ..
      dockerfile: infra/Dockerfile.lab
    container_name: wa2ai-lab
    ports:
      - "3000:3000"
    environment:
      # Debug mode (enabled by default in lab environment)
      - WA2AI_DEBUG=${WA2AI_DEBUG:-true}
      # Server port
      - WA2AI_PORT=3000
      # Provider selection: 'baileys' or 'evolution' (default: 'baileys')
      - WA2AI_PROVIDER=${WA2AI_PROVIDER:-baileys}
      # Evolution API configuration (only used if WA2AI_PROVIDER=evolution)
      - WA2AI_EVOLUTION_API_URL=http://evolution-api-lab:8080
      - WA2AI_EVOLUTION_API_KEY=${EVOLUTION_API_KEY:-default_key_change_me}
      # Baileys configuration (only used if WA2AI_PROVIDER=baileys)
      - WA2AI_BAILEYS_AUTH_DIR=/app/auth_info_baileys
    volumes:
      - baileys_auth:/app/auth_info_baileys
    # Dependencies:
    # - postgres: Always required for routes persistence
    # - evolution-api-lab: Only needed when WA2AI_PROVIDER=evolution (optional dependency)
    depends_on:
      postgres:
        condition: service_healthy
      evolution-api-lab:
        condition: service_started
        required: false
    extra_hosts:
      # Map host.docker.internal to the Docker gateway IP (for Linux compatibility)
      # This allows the container to access services running on the host machine
      - "host.docker.internal:host-gateway"
    networks:
      - wa2ai-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  evolution_data:
    driver: local
  postgres_data:
    driver: local
  baileys_auth:
    driver: local

networks:
  wa2ai-network:
    driver: bridge

